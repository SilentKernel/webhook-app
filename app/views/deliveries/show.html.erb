<% content_for(:title) { "Delivery Details - Deliveries" } %>

<div class="space-y-6">
  <div class="flex justify-between items-center">
    <div>
      <div class="text-sm breadcrumbs">
        <ul>
          <li><%= link_to "Deliveries", deliveries_path %></li>
          <li>Delivery Details</li>
        </ul>
      </div>
      <h1 class="text-3xl font-bold mt-2">Delivery Details</h1>
    </div>
    <div class="flex gap-2">
      <% if @delivery.retryable? %>
        <%= button_to "Retry Now", retry_delivery_path(@delivery),
            method: :post,
            class: "btn btn-primary",
            data: { turbo_confirm: "This will immediately retry the delivery. Continue?" } %>
      <% else %>
        <span class="btn btn-disabled" title="Can only retry failed deliveries">Retry Now</span>
      <% end %>
      <% if @delivery.cancellable? %>
        <%= button_to "Cancel", cancel_delivery_path(@delivery),
            method: :post,
            class: "btn btn-error",
            data: { turbo_confirm: "This will permanently cancel the delivery and stop all retries. Continue?" } %>
      <% end %>
    </div>
  </div>

  <div class="grid lg:grid-cols-2 gap-6">
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title">Delivery Information</h2>
        <div class="overflow-x-auto">
          <table class="table">
            <tbody>
              <tr>
                <th class="w-1/3">Event</th>
                <td>
                  <%= link_to @delivery.event.uid.truncate(20), event_path(@delivery.event), class: "link link-hover font-mono text-sm" %>
                </td>
              </tr>
              <tr>
                <th>Event Type</th>
                <td>
                  <span class="badge badge-outline"><%= @delivery.event.event_type || "—" %></span>
                </td>
              </tr>
              <tr>
                <th>Connection</th>
                <td>
                  <%= link_to @delivery.connection.source.name, source_path(@delivery.connection.source), class: "link link-hover" %>
                  <span class="mx-2">→</span>
                  <%= link_to @delivery.connection.destination.name, destination_path(@delivery.connection.destination), class: "link link-hover" %>
                </td>
              </tr>
              <tr>
                <th>Destination</th>
                <td>
                  <%= link_to @delivery.destination.name, destination_path(@delivery.destination), class: "link link-hover" %>
                </td>
              </tr>
              <tr>
                <th>Status</th>
                <td><%= delivery_status_badge(@delivery.status) %></td>
              </tr>
              <tr>
                <th>Attempts</th>
                <td><%= @delivery.attempt_count %> of <%= @delivery.max_attempts %></td>
              </tr>
              <tr>
                <th>Next Retry</th>
                <td><%= next_retry_display(@delivery) %></td>
              </tr>
              <tr>
                <th>Created</th>
                <td><%= @delivery.created_at.strftime("%B %d, %Y at %I:%M:%S %p") %></td>
              </tr>
              <tr>
                <th>Completed</th>
                <td>
                  <% if @delivery.completed_at.present? %>
                    <%= @delivery.completed_at.strftime("%B %d, %Y at %I:%M:%S %p") %>
                  <% else %>
                    <span class="text-base-content/50">—</span>
                  <% end %>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title">Status Summary</h2>
        <div class="stats stats-vertical shadow">
          <div class="stat">
            <div class="stat-title">Current Status</div>
            <div class="stat-value text-lg"><%= @delivery.status.titleize %></div>
          </div>
          <div class="stat">
            <div class="stat-title">Attempts Made</div>
            <div class="stat-value text-lg"><%= @delivery.attempt_count %></div>
            <div class="stat-desc">of <%= @delivery.max_attempts %> maximum</div>
          </div>
          <% if @delivery.can_retry? && !@delivery.success? %>
            <div class="stat">
              <div class="stat-title">Retries Remaining</div>
              <div class="stat-value text-lg"><%= @delivery.max_attempts - @delivery.attempt_count %></div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="card bg-base-100 shadow-xl">
    <div class="card-body">
      <h2 class="card-title">Delivery Attempts (<%= @attempts.count %>)</h2>
      <% if @attempts.any? %>
        <div class="space-y-4 mt-4">
          <% @attempts.each do |attempt| %>
            <div class="collapse collapse-arrow bg-base-200">
              <input type="checkbox" <%= "checked" if attempt == @attempts.last %> />
              <div class="collapse-title">
                <div class="flex items-center gap-4">
                  <span class="font-bold">#<%= attempt.attempt_number %></span>
                  <%= delivery_status_badge(attempt.status) %>
                  <% if attempt.response_status.present? %>
                    <span class="badge <%= attempt.success? ? 'badge-success' : 'badge-error' %>">
                      HTTP <%= attempt.response_status %>
                    </span>
                  <% end %>
                  <% if attempt.duration_ms.present? %>
                    <span class="text-sm text-base-content/60"><%= attempt.duration_ms %>ms</span>
                  <% end %>
                  <span class="text-sm text-base-content/60 ml-auto">
                    <%= attempt.attempted_at.strftime("%b %d, %Y at %I:%M:%S %p") %>
                  </span>
                </div>
              </div>
              <div class="collapse-content">
                <% request_body = attempt.decrypted_request_body %>
                <% response_body = attempt.decrypted_response_body %>

                <div class="space-y-4 pt-4">
                  <%# Row 1: Column Headers %>
                  <div class="grid md:grid-cols-2 gap-6">
                    <h4 class="font-semibold text-base">Request</h4>
                    <h4 class="font-semibold text-base">Response</h4>
                  </div>

                  <%# Row 2: URL / Status %>
                  <div class="grid md:grid-cols-2 gap-6 items-stretch">
                    <div class="bg-base-300 rounded-lg p-3">
                      <div class="text-xs text-base-content/60 uppercase tracking-wide mb-1">URL</div>
                      <code class="text-xs break-all"><%= attempt.request_url %></code>
                      <div class="mt-2">
                        <span class="badge badge-outline"><%= attempt.request_method %></span>
                      </div>
                    </div>
                    <div class="bg-base-300 rounded-lg p-3">
                      <div class="text-xs text-base-content/60 uppercase tracking-wide mb-1">Status</div>
                      <% if attempt.response_status.present? %>
                        <span class="badge <%= attempt.success? ? 'badge-success' : 'badge-error' %>">
                          <%= attempt.response_status %>
                        </span>
                      <% else %>
                        <span class="text-base-content/60 text-sm">No response received</span>
                      <% end %>
                    </div>
                  </div>

                  <%# Row 3: Headers %>
                  <div class="grid md:grid-cols-2 gap-6 items-stretch">
                    <div class="bg-base-200 rounded-lg">
                      <div class="flex items-center justify-between p-3 pb-0">
                        <div class="text-xs text-base-content/60 uppercase tracking-wide">Headers</div>
                        <% if attempt.request_headers.present? && attempt.request_headers.any? %>
                          <div data-controller="clipboard" data-clipboard-success-content-value="Copied!" class="inline-block">
                            <input type="hidden" value="<%= JSON.pretty_generate(attempt.request_headers) rescue attempt.request_headers.to_s %>" data-clipboard-target="source">
                            <button type="button" data-action="clipboard#copy" data-clipboard-target="button" class="btn btn-ghost btn-xs" title="Copy headers">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                              </svg>
                            </button>
                          </div>
                        <% end %>
                      </div>
                      <div class="max-h-40 overflow-y-auto">
                        <% if attempt.request_headers.present? && attempt.request_headers.any? %>
                          <%= highlight_code(JSON.pretty_generate(attempt.request_headers), language: "json") rescue highlight_code(attempt.request_headers.to_s) %>
                        <% else %>
                          <span class="text-base-content/50 text-sm p-3">No headers</span>
                        <% end %>
                      </div>
                    </div>
                    <div class="bg-base-200 rounded-lg">
                      <div class="flex items-center justify-between p-3 pb-0">
                        <div class="text-xs text-base-content/60 uppercase tracking-wide">Headers</div>
                        <% if attempt.response_headers.present? && attempt.response_headers.any? %>
                          <div data-controller="clipboard" data-clipboard-success-content-value="Copied!" class="inline-block">
                            <input type="hidden" value="<%= JSON.pretty_generate(attempt.response_headers) rescue attempt.response_headers.to_s %>" data-clipboard-target="source">
                            <button type="button" data-action="clipboard#copy" data-clipboard-target="button" class="btn btn-ghost btn-xs" title="Copy headers">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                              </svg>
                            </button>
                          </div>
                        <% end %>
                      </div>
                      <div class="max-h-40 overflow-y-auto">
                        <% if attempt.response_headers.present? && attempt.response_headers.any? %>
                          <%= highlight_code(JSON.pretty_generate(attempt.response_headers), language: "json") rescue highlight_code(attempt.response_headers.to_s) %>
                        <% else %>
                          <span class="text-base-content/50 text-sm p-3">No headers</span>
                        <% end %>
                      </div>
                    </div>
                  </div>

                  <%# Row 4: Body %>
                  <div class="grid md:grid-cols-2 gap-6 items-stretch">
                    <div class="bg-base-200 rounded-lg">
                      <div class="flex items-center justify-between p-3 pb-0">
                        <div class="text-xs text-base-content/60 uppercase tracking-wide">Body</div>
                        <% if request_body.present? %>
                          <div data-controller="clipboard" data-clipboard-success-content-value="Copied!" class="inline-block">
                            <input type="hidden" value="<%= begin JSON.pretty_generate(JSON.parse(request_body)) rescue request_body end %>" data-clipboard-target="source">
                            <button type="button" data-action="clipboard#copy" data-clipboard-target="button" class="btn btn-ghost btn-xs" title="Copy body">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                              </svg>
                            </button>
                          </div>
                        <% end %>
                      </div>
                      <div class="h-64 overflow-y-auto">
                        <% if request_body.present? %>
                          <%= begin
                            highlight_code(JSON.pretty_generate(JSON.parse(request_body)), language: "json")
                          rescue
                            highlight_code(request_body.truncate(2000))
                          end %>
                        <% else %>
                          <span class="text-base-content/50 text-sm p-3">No body</span>
                        <% end %>
                      </div>
                    </div>
                    <div class="bg-base-200 rounded-lg">
                      <div class="flex items-center justify-between p-3 pb-0">
                        <div class="text-xs text-base-content/60 uppercase tracking-wide">Body</div>
                        <% if response_body.present? %>
                          <div data-controller="clipboard" data-clipboard-success-content-value="Copied!" class="inline-block">
                            <input type="hidden" value="<%= begin JSON.pretty_generate(JSON.parse(response_body)) rescue response_body end %>" data-clipboard-target="source">
                            <button type="button" data-action="clipboard#copy" data-clipboard-target="button" class="btn btn-ghost btn-xs" title="Copy body">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                              </svg>
                            </button>
                          </div>
                        <% end %>
                      </div>
                      <div class="h-64 overflow-y-auto">
                        <% if response_body.present? %>
                          <%= begin
                            highlight_code(JSON.pretty_generate(JSON.parse(response_body)), language: "json")
                          rescue
                            highlight_code(response_body.truncate(2000))
                          end %>
                        <% else %>
                          <span class="text-base-content/50 text-sm p-3">No body</span>
                        <% end %>
                      </div>
                    </div>
                  </div>

                  <%# Row 5: Cleaned HTML Response (if applicable) %>
                  <% if response_body.present? && html_response?(response_body) %>
                    <div class="grid md:grid-cols-2 gap-6 items-start">
                      <div></div>
                      <div class="bg-base-200 rounded-lg">
                        <div class="text-xs text-base-content/60 uppercase tracking-wide p-3 pb-0">Cleaned Response</div>
                        <div class="max-h-48 overflow-y-auto">
                          <%= highlight_code(cleaned_response_body(response_body).truncate(2000)) %>
                        </div>
                      </div>
                    </div>
                  <% end %>

                  <%# Row 6: Error Message (if applicable) %>
                  <% if attempt.error_message.present? %>
                    <div class="alert alert-error">
                      <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      <div>
                        <h3 class="font-bold">Error</h3>
                        <div class="text-sm"><%= attempt.error_message %></div>
                        <% if attempt.error_code.present? %>
                          <div class="text-xs mt-1">Code: <%= attempt.error_code %></div>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-center py-8 text-base-content/60">
          <p>No delivery attempts yet.</p>
          <p class="text-sm mt-1">Attempts will appear here when the delivery is processed.</p>
        </div>
      <% end %>
    </div>
  </div>
</div>
