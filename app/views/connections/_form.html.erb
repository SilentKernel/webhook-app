<%= form_with model: connection, url: connection.persisted? ? connection_path(connection) : connections_path, class: "space-y-4", data: { controller: "connection-form", connection_form_source_edit_path_value: edit_modal_source_path("__ID__"), connection_form_destination_edit_path_value: edit_modal_destination_path("__ID__") } do |f| %>
  <% if connection.errors.any? %>
    <div class="alert alert-error">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <div>
        <ul class="text-sm list-disc list-inside">
          <% connection.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    </div>
  <% end %>

  <div class="form-control w-full">
    <%= f.label :name, class: "label" do %>
      <span class="label-text">Name</span>
    <% end %>
    <%= f.text_field :name, class: "input input-bordered w-full", placeholder: "Optional name for this connection" %>
    <label class="label">
      <span class="label-text-alt text-base-content/60">Leave blank to use "Source â†’ Destination" as the name</span>
    </label>
  </div>

  <div class="grid md:grid-cols-2 gap-4">
    <div class="form-control w-full">
      <%= f.label :source_id, class: "label" do %>
        <span class="label-text">Source <span class="text-error">*</span></span>
      <% end %>
      <%= render "connections/source_selector", sources: @sources, selected_id: params[:source_id] || connection.source_id %>
    </div>

    <div class="form-control w-full">
      <%= f.label :destination_id, class: "label" do %>
        <span class="label-text">Destination <span class="text-error">*</span></span>
      <% end %>
      <%= render "connections/destination_selector", destinations: @destinations, selected_id: params[:destination_id] || connection.destination_id %>
    </div>
  </div>

  <div class="grid md:grid-cols-2 gap-4">
    <div class="form-control w-full">
      <%= f.label :status, class: "label" do %>
        <span class="label-text">Status <span class="text-error">*</span></span>
      <% end %>
      <%= f.select :status, [
        ["Active", "active"],
        ["Paused", "paused"],
        ["Disabled", "disabled"]
      ], {}, class: "select select-bordered w-full" %>
    </div>

    <div class="form-control w-full">
      <%= f.label :priority, class: "label" do %>
        <span class="label-text">Priority</span>
      <% end %>
      <%= f.number_field :priority, class: "input input-bordered w-full", value: connection.priority || 0, min: 0 %>
      <label class="label">
        <span class="label-text-alt text-base-content/60">Lower numbers = higher priority</span>
      </label>
    </div>
  </div>

  <fieldset class="fieldset border border-base-300 rounded-lg p-4"
            data-controller="rules-editor"
            data-rules-editor-rules-value="<%= connection.rules.to_json %>"
            data-rules-editor-connections-value="<%= @connections_with_rules.to_json %>">
    <legend class="text-sm font-medium px-2">Rules Configuration</legend>

    <input type="hidden"
           name="connection[rules]"
           data-rules-editor-target="hiddenField"
           value="<%= connection.rules.present? ? connection.rules.to_json : '' %>">

    <% if @connections_with_rules.present? %>
      <div class="mb-4 flex flex-wrap items-center gap-2">
        <span class="text-sm text-base-content/60">Import from:</span>
        <select class="select select-bordered select-sm"
                data-rules-editor-target="importSelect">
          <option value="">Select connection...</option>
          <% @connections_with_rules.each do |conn| %>
            <% next if conn.id == connection.id %>
            <option value="<%= conn.id %>"><%= conn.name.presence || "Connection ##{conn.id}" %></option>
          <% end %>
        </select>
        <button type="button"
                class="btn btn-sm btn-ghost"
                data-action="click->rules-editor#importRules">
          Import
        </button>
      </div>
    <% end %>

    <div class="mb-4">
      <label class="label">
        <span class="label-text font-medium">Event Type Filter</span>
      </label>
      <div class="bg-base-200 rounded-lg p-3">
        <div class="flex flex-wrap gap-2 mb-3" data-rules-editor-target="eventTypesContainer">
        </div>
        <div class="flex gap-2">
          <input type="text"
                 class="input input-bordered input-sm flex-1"
                 placeholder="Enter event type (e.g., payment.completed)"
                 data-rules-editor-target="eventTypeInput"
                 data-action="keydown->rules-editor#addEventTypeOnEnter">
          <button type="button"
                  class="btn btn-sm btn-primary"
                  data-action="click->rules-editor#addEventType">
            Add
          </button>
        </div>
      </div>
      <label class="label">
        <span class="label-text-alt text-base-content/60">Leave empty to forward all events</span>
      </label>
    </div>

    <div>
      <label class="label">
        <span class="label-text font-medium">Delivery Delay (optional)</span>
      </label>
      <div class="flex items-center gap-2">
        <input type="number"
               class="input input-bordered input-sm w-24"
               min="0"
               value="0"
               data-rules-editor-target="delayInput"
               data-action="change->rules-editor#updateDelay">
        <span class="text-sm text-base-content/60">seconds</span>
      </div>
      <label class="label">
        <span class="label-text-alt text-base-content/60">Add a delay before delivering webhooks to this destination</span>
      </label>
    </div>
  </fieldset>

  <fieldset class="fieldset border border-base-300 rounded-lg p-4" data-controller="header-forwarding">
    <legend class="text-sm font-medium px-2">Header Forwarding</legend>
    <p class="text-sm text-base-content/60 mb-4">
      Forward original webhook headers (e.g., Stripe-Signature) to the destination for signature verification.
    </p>

    <div class="form-control">
      <label class="label cursor-pointer justify-start gap-3">
        <%= f.check_box :forward_all_headers,
            class: "checkbox checkbox-primary",
            data: { action: "header-forwarding#toggle" } %>
        <span class="label-text">Forward all original headers</span>
      </label>
      <label class="label pt-0">
        <span class="label-text-alt text-base-content/60">Forwards all headers except Host, Content-Length, Connection, and Transfer-Encoding</span>
      </label>
    </div>

    <div class="form-control w-full mt-2" data-header-forwarding-target="specificHeaders">
      <%= f.label :forward_headers, class: "label" do %>
        <span class="label-text">Specific headers to forward</span>
      <% end %>
      <%= f.text_field :forward_headers,
          value: connection.forward_headers&.join(", "),
          class: "input input-bordered w-full",
          placeholder: "Stripe-Signature, X-Shopify-Hmac-SHA256" %>
      <label class="label">
        <span class="label-text-alt text-base-content/60">Comma-separated list of header names to forward</span>
      </label>
    </div>

    <div class="mt-3 p-3 bg-base-200 rounded-lg text-sm">
      <p class="text-base-content/80">
        <strong>Auto-forwarding:</strong> If you don't specify headers and don't enable "Forward all headers",
        signature headers from the source type will be forwarded automatically:
      </p>
      <ul class="mt-2 ml-4 list-disc text-base-content/60 text-xs">
        <li><strong>Stripe:</strong> Stripe-Signature</li>
        <li><strong>Shopify:</strong> X-Shopify-Hmac-Sha256, X-Shopify-Topic, etc.</li>
        <li><strong>GitHub:</strong> X-Hub-Signature-256, X-GitHub-Event, etc.</li>
        <li><strong>Twilio:</strong> X-Twilio-Signature</li>
      </ul>
    </div>
  </fieldset>

  <div class="flex gap-4 mt-6">
    <%= f.submit connection.persisted? ? "Update Connection" : "Create Connection", class: "btn btn-primary flex-1" %>
    <%= link_to "Cancel", connection.persisted? ? connection_path(connection) : connections_path, class: "btn btn-ghost" %>
  </div>
<% end %>
